---
title: Intercept HTTP requests
slug: Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests
translation_of: Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests
---
<div><section class="Quick_links" id="Quick_Links">
  <ol>
    <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions"><strong>Browser extensions</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Getting started</summary>
        <ol>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/What_are_WebExtensions">What are extensions?</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Your_first_WebExtension">Your first extension</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Your_second_WebExtension">Your second extension</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Anatomy_of_a_WebExtension">Anatomy of an extension</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Examples">Example extensions</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/What_next_">What next?</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>Concepts</summary>
        <ol>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Using_the_JavaScript_APIs">Using the JavaScript APIs</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Content_scripts">Content scripts</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Match_patterns">Match patterns</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Working_with_files">Working with files</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Internationalization">Internationalization</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy">Content Security Policy</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Native_messaging">Native messaging</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Differences_between_API_implementations">Differences between API implementations</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Chrome_incompatibilities">Chrome incompatibilities</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>User interface</summary>
        <ol>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface">User Interface</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Browser_action">Toolbar button</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Page_actions">Address bar button</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Sidebars">Sidebars</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Context_menu_items">Context menu items</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Options_pages">Options page</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Extension_pages">Extension pages</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Notifications">Notifications</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/Omnibox">Address bar suggestions</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/user_interface/devtools_panels">Developer tools panels</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>How to</summary>
        <ol>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Intercept_HTTP_requests">Intercept HTTP requests</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Modify_a_web_page">Modify a web page</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Safely_inserting_external_content_into_a_page">Insert external content</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Sharing_objects_with_page_scripts">Share objects with page scripts</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Add_a_button_to_the_toolbar">Add a button to the toolbar</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Implement_a_settings_page">Implement a settings page</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Working_with_the_Tabs_API">Work with the Tabs API</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Bookmarks_API">Work with the Bookmarks API</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Work_with_the_Cookies_API">Work with the Cookies API</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Work_with_contextual_identities">Work with contextual identities</a></li>
          <li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Build_a_cross_browser_extension">Build a cross-browser extension</a></li>
        </ol>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Firefox_differentiators">Firefox differentiators</a></summary>
      </details>
    </li>
    <li class="toggle">
      <details>
        <summary>JavaScript APIs</summary>
        <ol><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/Browser_support_for_JavaScript_APIs">Browser support for JavaScript APIs</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/cookies">cookies</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/downloads">downloads</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/runtime">runtime</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/tabs">tabs</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/windows">windows</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest">webRequest</a></li></ol>
      </details>
    </li>
    <li class="toggle">
      <details>
      <summary>Manifest keys</summary>
      <ol><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/content_security_policy">content_security_policy</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/description">description</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions">permissions</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/background">ключ background</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/icons">ключ icons</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/manifest_version">ключ manifest_version</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/name">ключ name</a></li><li><a href="/ru/docs/Mozilla/Add-ons/WebExtensions/manifest.json/version">ключ version</a></li></ol>
      </details>
    </li>
     <li class="toggle">
      <details>
        <summary>Extension Workshop</summary>
        <ol>
          <li><a href="https://extensionworkshop.com/documentation/develop/">Develop</a></li>
          <li><a href="https://extensionworkshop.com/documentation/publish/">Publish</a></li>
          <li><a href="https://extensionworkshop.com/documentation/manage/">Manage</a></li>
          <li><a href="https://extensionworkshop.com/documentation/enterprise/">Enterprise</a></li>
        </ol>
      </details>
    </li>
    <li><a href="/ru/docs/Mozilla/Add-ons/Contact_us"><strong>Contact us</strong></a></li>
    <li class="toggle">
      <details>
        <summary>Channels</summary>
        <ol>
          <li><a href="https://blog.mozilla.org/addons">Add-ons blog</a></li>
          <li><a href="https://discourse.mozilla.org/c/add-ons">Add-ons forum</a></li>
          <li><a href="https://chat.mozilla.org/#/room/%23addons:mozilla.org">Add-ons chat</a></li>
        </ol>
      </details>
    </li>
  </ol>
</section></div>

<ul>
 <li>
  <h2 id="Для_перехвата_HTTP_запросов_используйте_webRequest_API._Этот_API_позволит_вам_добавлять_слушателей_на_различных_этапах_создания_HTTP_запросов._В_слушателях_вы_можете">Для перехвата  HTTP запросов используйте <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest" title="Добавляет обработчики событий на различных стадиях HTTP запроса. Обработчик получет детальную информацию о запросе и способен изменить или отменить запрос."><code>webRequest</code></a> API. Этот API позволит вам добавлять слушателей, на различных этапах создания HTTP запросов. В слушателях вы можете:</h2>
 </li>
 <li>получить доступ к заголовкам и телам запроса, к заголовкам ответа</li>
 <li>отменять и перенаправлять запросы</li>
 <li>изменять запрос и заголовки ответа</li>
</ul>

<p>В этой статье мы рассмотрим три разных способа использования <code>webRequest</code> модуля:</p>

<ul>
 <li>Логирование URL сделанных запросов.</li>
 <li>Перенаправление запросов.</li>
 <li>Модификация заголовков запроса.</li>
</ul>

<h2 id="Логирование_URL_запросов">Логирование URL запросов</h2>

<p>Создайте новый каталог "requests". В нём создайте файл "manifest.json" со следующим содержимым:</p>

<pre class="brush: json notranslate">{
  "description": "Demonstrating webRequests",
  "manifest_version": 2,
  "name": "webRequest-demo",
  "version": "1.0",

  "permissions": [
    "webRequest",
    "&lt;all_urls&gt;"
  ],

  "background": {
    "scripts": ["background.js"]
  }
}</pre>

<p>Далее, создайте файл "background.js" со следующим содержимым:</p>

<pre class="brush: js notranslate">function logURL(requestDetails) {
  console.log("Loading: " + requestDetails.url);
}

browser.webRequest.onBeforeRequest.addListener(
  logURL,
  {urls: ["&lt;all_urls&gt;"]}
);

</pre>

<p>Здесь мы используем <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/onBeforeRequest" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>onBeforeRequest</code></a> для вызова функции <code>logURL()</code> перед началом запроса. Функция <code>logURL()</code> берёт URL запроса из объекта event и выводит в консоль браузера. <a href="/en-US/Add-ons/WebExtensions/Match_patterns">Шаблон</a> <code>{urls: ["&lt;all_urls&gt;"]}</code> означает, что мы будем перехватывать HTTP запросы ко всем URL.</p>

<p>Для проверки <a href="/en-US/Add-ons/WebExtensions/Temporary_Installation_in_Firefox">проинсталлируйте WebExtension</a>, <a href="/en-US/docs/Tools/Browser_Console">откройте консоль браузера</a> и откройте какую-нибудь веб-страницу. В консоли вы должны увидеть URL для каждого ресурса, который запрашивает браузер:</p>

<div class="intrinsic-wrapper"><div class="intrinsic-container "><iframe src="https://www.youtube.com/embed/X3rMgkRkB1Q?rel=0&amp;html5=1"></iframe></div></div>

<h2 id="Перенаправление_запросов">Перенаправление запросов</h2>

<p>Теперь давайте использовать <code>webRequest</code> для перенаправления HTTP-запросов. Во-первых, замените manifest.json на это:</p>

<pre class="brush: json notranslate">{

  "description": "Demonstrating webRequests",
  "manifest_version": 2,
  "name": "webRequest-demo",
  "version": "1.0",

  "permissions": [
    "webRequest",
    "webRequestBlocking",
    "https://mdn.mozillademos.org"
  ],

  "background": {
    "scripts": ["background.js"]
  }

}</pre>

<p class="result">Единственное изменение здесь заключается в добавлении <code>"webRequestBlocking"</code> в <code>permission</code>. Мы должны запрашивать это дополнительное разрешение каждый раз, когда мы изменяем запрос.</p>

<p>Затем замените «background.js» следующим образом:</p>

<pre class="brush: js notranslate">var pattern = "https://mdn.mozillademos.org/*";

function redirect(requestDetails) {
  console.log("Redirecting: " + requestDetails.url);
  return {
    redirectUrl: "https://38.media.tumblr.com/tumblr_ldbj01lZiP1qe0eclo1_500.gif"
  };
}

browser.webRequest.onBeforeRequest.addListener(
  redirect,
  {urls:[pattern], types:["image"]},
  ["blocking"]
);</pre>

<p class="result">Опять же, мы используем <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/onBeforeRequest" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>onBeforeRequest</code></a> прослушиватель событий для запуска функции непосредственно перед каждым запросом. Эта функция заменит целевой URL на <code>redirectUrl</code> указанный в функции.</p>

<p class="result">На этот раз мы не перехватываем каждый запрос: опция <code>{urls: [pattern], types: ["image"]}</code> указывает, что мы должны перехватывать запросы (1) для URL-адресов, находящихся в разделе «https://mdn.mozillademos.org / "(2) для ресурсов изображения. Подробнее см. <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/RequestFilter" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>webRequest.RequestFilter</code></a>.</p>

<p>Также обратите внимание, что мы передаем опцию <code>"blocking"</code>: нам нужно передать это, когда мы хотим изменить запрос. Это заставляет функцию прослушивателя блокировать сетевой запрос, поэтому браузер ждет, пока слушатель вернется, прежде чем продолжить. Дополнительную информацию о <code>"blocking"</code> смотрите в документации <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/onBeforeRequest" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>webRequest.onBeforeRequest</code></a>.</p>

<p>Чтобы проверить это, откройте страницу в MDN, которая содержит много изображений (например, https://developer.mozilla.org/en-US/docs/Tools/Network_Monitor), перезагрузите WebExtension и перезагрузите страницу MDN :</p>

<div class="intrinsic-wrapper"><div class="intrinsic-container "><iframe src="https://www.youtube.com/embed/ix5RrXGr0wA?rel=0&amp;html5=1"></iframe></div></div>

<h2 id="Modifying_request_headers">Modifying request headers</h2>

<p>Finally we'll use <code>webRequest</code> to modify request headers. In this example we'll modify the "User-Agent" header so the browser identifies itself as Opera 12.16, but only when visiting pages under http://useragentstring.com/".</p>

<p>The "manifest.json" can stay the same as in the previous example.</p>

<p>Replace "background.js" with code like this:</p>

<pre class="brush: js notranslate">var targetPage = "http://useragentstring.com/*";

var ua = "Opera/9.80 (X11; Linux i686; Ubuntu/14.10) Presto/2.12.388 Version/12.16";

function rewriteUserAgentHeader(e) {
  for (var header of e.requestHeaders) {
    if (header.name.toLowerCase() == "user-agent") {
      header.value = ua;
    }
  }
  return {requestHeaders: e.requestHeaders};
}

browser.webRequest.onBeforeSendHeaders.addListener(
  rewriteUserAgentHeader,
  {urls: [targetPage]},
  ["blocking", "requestHeaders"]
);</pre>

<p>Here we use the <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/onBeforeSendHeaders" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>onBeforeSendHeaders</code></a> event listener to run a function just before the request headers are sent.</p>

<p>The listener function will be called only for requests to URLs matching the <code>targetPage</code> <a href="/en-US/Add-ons/WebExtensions/Match_patterns">pattern</a>. Also note that we've again passed <code>"blocking"</code> as an option. We've also passed <code>"requestHeaders"</code>, which means that the listener will be passed an array containing the request headers that we expect to send. See <a href="/ru/docs/Mozilla/Add-ons/WebExtensions/API/webRequest/onBeforeSendHeaders" title="Документация об этом ещё не написана; пожалуйста, поспособствуйте её написанию!"><code>webRequest.onBeforeSendHeaders</code></a> for more information on these options.</p>

<p>The listener function looks for the "User-Agent" header in the array of request headers, replaces its value with the value of the <code>ua</code> variable, and returns the modified array. This modified array will now be sent to the server.</p>

<p>To test it out, open <a href="http://useragentstring.com/">useragentstring.com</a> and check that it identifies the browser as Firefox. Then reload the add-on, reload <a href="http://useragentstring.com/">useragentstring.com</a>, and check that Firefox is now identified as Opera:</p>

<div class="intrinsic-wrapper"><div class="intrinsic-container "><iframe src="https://www.youtube.com/embed/SrSNS1-FIx0?rel=0&amp;html5=1"></iframe></div></div>

<h2 id="Learn_more">Learn more</h2>

<p>To learn about all the things you can do with the <code>webRequest</code> API, see its <a href="/en-US/Add-ons/WebExtensions/API/WebRequest">reference documentation</a>.</p>
